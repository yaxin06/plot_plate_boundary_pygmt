name: Generate PyGMT images (CI)

on:
  workflow_dispatch:
  # optional: run when there are changes to scripts or docs
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/generate-pygmt-images.yml'

jobs:
  generate:
    name: generate-images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: '3.11'
          activate-environment: pygmt-env
          auto-update-conda: true

      - name: Ensure mamba then install packages (conda-forge)
        shell: bash -l {0}
        run: |
          # some runners don't have mamba in PATH; install to base first
          conda install -n base -c conda-forge -y mamba || true
          mamba --version || true
          mamba install -c conda-forge -y pygmt gmt python=3.11

      - name: Verify pygmt
        run: python -c "import pygmt; print('pygmt', pygmt.__version__)"

      - name: Generate images (script)
        run: python scripts/generate_pygmt_images.py

      - name: Create PR with images (if changed)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(ci): auto-generate PyGMT images in docs/'
          branch: 'pygmt/generated-images'
          title: 'ci: autogenerated PyGMT images (docs)'
          body: |
            This PR was created automatically by the CI workflow to add generated PyGMT images into the `docs/` folder.
          labels: autogenerated, ci
